<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>Real-time yurish - Foydalanuvchi</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { height: 90vh; }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center">ğŸ“ Foydalanuvchi yurish xaritasi</h2>
  <button id="stop-btn">ğŸš© Ishni tugatish</button>
  <div id="map"></div>

  <script>
    const map = L.map("map").setView([40.4, 71.76], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const user = {
      track: [],
      polyline: null,
      lastLat: null,
      lastLon: null,
      totalDistance: 0,
      startTime: new Date(),
      lastMoveTime: new Date(),
      color: 'blue',
      currentMarker: null,
      stopCount: 0
    };

    let watchId;
    let tracking = true;

    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }

    function getDistanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) *
        Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function formatTime(date) {
      return date.toTimeString().split(" ")[0];
    }

    function addLocation(lat, lon) {
      const now = new Date();
      const isFirst = user.track.length === 0;

      // Masofa
      let dist = 0;
      if (!isFirst) {
        dist = getDistanceKm(user.lastLat, user.lastLon, lat, lon);
        if (dist > 0.01) { // harakat boâ€˜lsa
          user.lastMoveTime = now;
        }
      }

      user.totalDistance += dist;
      user.lastLat = lat;
      user.lastLon = lon;
      user.track.push([lat, lon]);

      // Polyline
      if (!user.polyline) {
        user.polyline = L.polyline(user.track, { color: user.color }).addTo(map);
        L.marker([lat, lon]).addTo(map).bindPopup(`ğŸš€ Boshlanish nuqtasi<br>ğŸ•’ ${formatTime(now)}`);
      } else {
        user.polyline.setLatLngs(user.track);
      }

      // Harakat markeri
      if (user.currentMarker) map.removeLayer(user.currentMarker);
      user.currentMarker = L.circleMarker([lat, lon], {
        radius: 8,
        color: user.color,
        fillColor: user.color,
        fillOpacity: 1
      }).addTo(map);

      // Agar 10 sekunddan koâ€˜p harakatsiz boâ€˜lsa => toâ€˜xtash deb belgilansin
      const diffSec = (now - user.lastMoveTime) / 1000;
      if (diffSec >= 10 && dist < 0.005) {
        user.stopCount++;
        const totalSec = Math.floor((now - user.startTime) / 1000);
        const distanceKm = user.totalDistance.toFixed(2);
        L.marker([lat, lon])
          .addTo(map)
          .bindPopup(
            `ğŸ›‘ Toâ€˜xtash nuqtasi #${user.stopCount}<br>` +
            `ğŸ•’ ${formatTime(now)}<br>` +
            `ğŸ•“ Yurilgan vaqt: ${totalSec} soniya<br>` +
            `ğŸ“ Masofa: ${distanceKm} km`
          );
        user.lastMoveTime = now;
      }
    }

    // Geolocationni boshlash
    function startTracking() {
      if (!navigator.geolocation) {
        alert("Geolocation qoâ€˜llab-quvvatlanmaydi!");
        return;
      }

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          if (!tracking) return;
          const { latitude, longitude } = pos.coords;
          addLocation(latitude, longitude);
        },
        (err) => {
          alert("Xatolik: " + err.message);
        },
        { enableHighAccuracy: true }
      );
    }

    document.getElementById("stop-btn").addEventListener("click", () => {
      tracking = false;
      navigator.geolocation.clearWatch(watchId);
      const now = new Date();
      const totalSec = Math.floor((now - user.startTime) / 1000);
      const distanceKm = user.totalDistance.toFixed(2);
      alert(
        `âœ… Harakat tugadi:\nğŸ•“ Vaqt: ${totalSec} soniya\nğŸ“ Masofa: ${distanceKm} km\nğŸ›‘ Toâ€˜xtashlar: ${user.stopCount} ta`
      );
    });

    startTracking();
  </script>
</body>
</html>
